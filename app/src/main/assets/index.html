<!DOCTYPE html>
<!--<html lang="en">-->
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Plot Visualization</title>
<!--    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body {
          font-family: Arial, sans-serif;
          margin: 0;
          padding: 0;
        }

        #header {
    position: fixed; /* Keeps the header fixed at the top */
    top: 0;
    left: 0;
    width: 100%; /* Full-width header */
    background-color: white; /* Gray background */
    padding: 5px 0; /* Padding to give spacing inside the header */
    text-align: center; /* Centers the title */
    box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2); /* Adds slight shadow */
    z-index: 1000; /* Ensures it's above other elements */
    display: flex;
    justify-content: center;
    align-items: center;
    height: 50px; /* Set a fixed height for the header */
}

/* Title inside the header */
#header-title {
    font-size: 16px; /* Reduce text size */
    color: black; /* White text for contrast */
    padding: 5px 10px; /* Add padding inside the text box */
}


        #map {
          height: 90vh;
          width: 100%;
        }

        #status {
          text-align: center;
          padding: 10px;
          background-color: #e7f5e9;
          border-top: 1px solid #ddd;
          color: #333;
          font-weight: bold;
        }

        #status.error {
          background-color: #fbeaea;
          color: #a94442;
        }


        /* Container for the button */
        .map-types {
            position: absolute;
            top: 10px;
            /* Align to the top */
            right: 10px;
            /* Align to the right */
            z-index: 1100;
        }

        /* Styling for the button with a gray background */

        #mapTypesDropdown {
            background: white;
            /* Gray background */
            border: 3px solid gray;
            /* Thicker gray border */
            padding: 12px;
            /* Increase padding for a larger button */
            cursor: pointer;
            font-size: 22px;
            /* Increase font size */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            /* More rounded corners */
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
            /* Stronger shadow for visibility */
            width: 50px;
            /* Increase width */
            height: 50px;
            /* Increase height */
        }

        /* Ensure the icon remains unchanged */
        #mapTypesDropdown i {
            font-size: 22px;
            color: gray;
            /* White icon color */
        }

        /* Hover effect */
        #mapTypesDropdown:hover {
            background: white;
        }



        /* Dropdown content styles */
        .dropdown-content {
            display: none;
            position: absolute;
            top: 45px;
            /* Position below the button */
            right: 0;
            /* Align to the right */
            background-color: rgba(134, 131, 131, 0.9);
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            padding: 5px;
            min-width: 140px;
            z-index: 1101;
            /* üî• Ensures dropdown is in front of everything */
        }

        /* Dropdown items */
        .dropdown-content button {
            width: 100%;
            background: none;
            border: none;
            padding: 10px 15px;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: black;
            display: flex;
            align-items: center;
        }

        .dropdown-content button i {
            margin-right: 8px;
            /* Spacing between icon and text */
        }

        /* Hover effect */
        .dropdown-content button:hover {
            background-color: rgb(11, 233, 233);
        }

        /* Show dropdown when button is clicked */
        .show {
            display: block;
        }
    </style>
</head>
<body>
<div id="header">
    <h1 id="header-title">Plot Visualization</h1>
</div>
<div id="map"></div>
<div class="map-types">
    <button id="mapTypesDropdown" class="dropdown-toggle">
        <i class="fas fa-layer-group"></i>
    </button>
    <div id="dropdownContent" class="dropdown-content">
        <button id="streetView">
            <i class="fas fa-street-view"></i> <span id="streetViewText"></span>
        </button>
        <button id="satelliteView">
            <i class="fas fa-satellite"></i> <span id="satelliteViewText"></span>
        </button>
        <button id="terrainView">
            <i class="fas fa-mountain"></i> <span id="terrainViewText"></span>
        </button>
    </div>
</div>
<div id="status">Loading map...</div>

<script>
    // Register the service worker for offline caching
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("./service-worker.js")
        .then(() => {
          console.log("Service Worker registered for offline map caching");
        })
        .catch((error) => {
          console.error("Service Worker registration failed:", error);
        });
    }

    // Function to parse query parameters from URL
    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        center: params.get("center"),
        zoom: params.get("zoom"),
        lang: params.get("lang") || "en",
        plotId: params.get("plotId"),
      };
    }

    // Extract parameters and initialize the map
    // ‚úÖ Extract parameters
  const { lang, center, zoom, plotId } = getQueryParams();
  console.log('Selected Language:', lang);

    // ‚úÖ Translation Object
    const translations = {
      en: {
        serviceWorkerSuccess:
          "Service Worker registered for offline map caching.",
        serviceWorkerError: "Service Worker registration failed:",
        mapLoaded: "Map loaded successfully!",
        errorLoadingMap: "Error loading map:",
        centroidInfo: "Centroid Information",
        latitude: "Latitude",
        longitude: "Longitude",
        farmInfo: "Farm Information",
        siteId: "Site ID",
        farmer: "Farmer",
        village: "Village",
        district: "District",
        size: "Size",
        accuracy: "Accuracy",
        hectares: "sq units",
        missingCoordinates:
          "Coordinates are missing or empty. Using latitude and longitude instead.",
        header: "Plot Visualization",
        loadingMap: "Loading map...",
        streetView: "Street View",
        satelliteView: "Satellite View",
        terrainView: "Terrain View",
      },
      fr: {
    serviceWorkerSuccess:
      "Service Worker enregistr√© pour la mise en cache de la carte hors ligne.",
    serviceWorkerError: "L'enregistrement du Service Worker a √©chou√© :",
    mapLoaded: "Carte charg√©e avec succ√®s !",
    errorLoadingMap: "Erreur lors du chargement de la carte :",
    centroidInfo: "Informations sur le centro√Øde",
    latitude: "Latitude",
    longitude: "Longitude",
    farmInfo: "Informations sur la ferme",
    siteId: "ID du site",
    farmer: "Agriculteur",
    village: "Village",
    district: "District",
    size: "Taille",
    accuracy: "Pr√©cision",
    hectares: "unit√©s carr√©es",
    missingCoordinates:
      "Les coordonn√©es sont manquantes ou vides. Utilisation de la latitude et de la longitude √† la place.",
    header: "Visualisation de la parcelle",
    loadingMap: "Chargement de la carte...",
    streetView: "Vue de la rue",
    satelliteView: "Vue satellite",
    terrainView: "Vue du terrain",
  },
  es: {
    serviceWorkerSuccess:
      "Service Worker registrado para la cach√© del mapa sin conexi√≥n.",
    serviceWorkerError: "Fall√≥ el registro del Service Worker:",
    mapLoaded: "¬°Mapa cargado con √©xito!",
    errorLoadingMap: "Error al cargar el mapa:",
    centroidInfo: "Informaci√≥n del centroide",
    latitude: "Latitud",
    longitude: "Longitud",
    farmInfo: "Informaci√≥n de la granja",
    siteId: "ID del sitio",
    farmer: "Agricultor",
    village: "Pueblo",
    district: "Distrito",
    size: "Tama√±o",
    accuracy: "Precisi√≥n",
    hectares: "unidades cuadradas",
    missingCoordinates:
      "Faltan las coordenadas o est√°n vac√≠as. Se utilizar√°n latitud y longitud en su lugar.",
    header: "Visualizaci√≥n de parcelas",
    loadingMap: "Cargando mapa...",
    streetView: "Vista de calle",
    satelliteView: "Vista satelital",
    terrainView: "Vista de terreno",
  },

      sw: {
        serviceWorkerSuccess:
          "Huduma ya Mtandaoni imesajiliwa kwa uhifadhi nje ya mtandao.",
        serviceWorkerError: "Usajili wa Huduma ya Mtandaoni umeshindikana:",
        mapLoaded: "Ramani imepakiwa kwa mafanikio!",
        errorLoadingMap: "Hitilafu katika kupakia ramani:",
        centroidInfo: "Taarifa ya Kati",
        latitude: "Latitudo",
        longitude: "Longitudo",
        farmInfo: "Taarifa ya Shamba",
        siteId: "Kitambulisho cha Tovuti",
        farmer: "Mkulima",
        village: "Kijiji",
        district: "Wilaya",
        size: "Ukubwa",
        accuracy: "Usahihi",
        hectares: "mita za mraba",
        missingCoordinates:
          "Hakuna viwianishi. Inatumia latitudo na longitudo badala yake.",
        header: "Taswira ya Kiwanja",
        loadingMap: "Ramani inapakia...",
        streetView: "Mtazamo wa barabara",
                satelliteView: "Mtazamo wa setilaiti",
                terrainView: "Mtazamo wa ardhi",
      },
      am: {
        serviceWorkerSuccess: "·ä†·åà·àç·åç·àé·âµ ·à†·à´·â∞·äõ ·àà·ä¶·çç·àã·ã≠·äï ·àò·à∞·â•·à∞·â• ·â∞·àò·ãù·åç·âß·àç·ç¢",
        serviceWorkerError: "·ä†·åà·àç·åç·àé·âµ ·à†·à´·â∞·äõ ·àò·àò·ãù·åà·â• ·ä†·àç·â∞·à≥·ä´·àù·ç¶",
        mapLoaded: "·ä´·à≠·â≥·ãç ·â†·â∞·à≥·ä´ ·àÅ·äî·â≥ ·â∞·å≠·äó·àç·ç¢",
        errorLoadingMap: "·ä´·à≠·â≥ ·àõ·äï·âÄ·à≥·âÄ·àµ ·àµ·àÖ·â∞·âµ·ç¶",
        centroidInfo: "·ã®·àò·àÄ·ä®·àç ·àò·à®·åÉ",
        latitude: "·ä¨·äï·âµ·àÆ·ã≤·ãµ",
        longitude: "·àé·äï·åç·â≤·ãµ",
        farmInfo: "·ã®·ä†·à≠·à∂ ·ä†·ã∞·à≠ ·àò·à®·åÉ",
        siteId: "·ã®·ä†·ã≥·à´·àΩ ·àò·â≥·ãà·âÇ·ã´",
        farmer: "·ä†·à≠·à∂ ·ä†·ã∞·à≠",
        village: "·àò·äï·ã∞·à≠",
        district: "·ãû·äï",
        size: "·àò·å†·äï",
        accuracy: "·âµ·ä≠·ä≠·àà·äõ·äê·âµ",
        hectares: "·ä©·â£·äï·ã´",
        missingCoordinates: "·ä†·ä´·â£·â¢ ·ã®·àà·àù·ç¢ ·àã·â≤·âµ·ã±·äï ·ä•·äì ·àé·äï·åç·â≤·ã±·äï ·â†·àò·å†·âÄ·àù ·âÄ·å•·àè·àç·ç¢",
        header: "·ã®·àò·à¨·âµ ·àù·àµ·àç",
        loadingMap: "·ä´·à≠·â≥ ·â†·àò·å´·äï ·àã·ã≠...",
        streetView: "·ã®·åé·ã≥·äì ·ä•·ã≠·â≥",
                satelliteView: "·ã®·à≥·â∞·àã·ã≠·âµ ·ä•·ã≠·â≥",
                terrainView: "·ã®·àò·à¨·âµ ·ä•·ã≠·â≥",
      },
      om: {
        serviceWorkerSuccess:
          "Tajaajila intarneetii bilisummaa keessatti galmaa'e.",
        serviceWorkerError: "Tajaajilli intarneetii galmaa'uu hin dandeenye:",
        mapLoaded: "Kaartaan milkaa'inaan fe'ameera!",
        errorLoadingMap: "Kaartaa fe'uu keessatti dogoggora:",
        centroidInfo: "Odeeffannoo Giddugaleessaa",
        latitude: "Laatiitiiyuudii",
        longitude: "Loongitiiyuudii",
        farmInfo: "Odeeffannoo Qonnaa",
        siteId: "Iddoo Beeksisuu",
        farmer: "Qonnaan Bultoota",
        village: "Ganda",
        district: "Godina",
        size: "Bal'ina",
        accuracy: "Sirrii",
        hectares: "Hektaroota",
        missingCoordinates:
          "Hirriba hin qabu. Laatiitiiyuudii fi Loongitiiyuudii fayyadamuun hojjatame.",
        header: "Ilaalcha Qonnaa",
        loadingMap: "Kaartaa fe'amaa jira...",
        streetView: "Mul'ata Daandii",
                satelliteView: "Mul'ata Satellite",
                terrainView: "Mul'ata Lafaa",
      },
    };

    // ‚úÖ Function to get translated text
    function t(key) {
      return translations[lang]?.[key] || translations["en"][key]; // Default to English
    }

      // Function to update translations
      function updateTranslations(language) {
            document.getElementById("streetViewText").textContent = translations[language].streetView;
            document.getElementById("satelliteViewText").textContent = translations[language].satelliteView;
            document.getElementById("terrainViewText").textContent = translations[language].terrainView;
        }

    document.addEventListener("DOMContentLoaded", function () {

      document.getElementById('header-title').textContent = t('header');
      document.getElementById('status').textContent = t('loadingMap');

      if (
        plotId &&
        typeof Android !== "undefined" &&
        Android.getSelectedPlot
      ) {
        console.log("Android interface is available.");
        console.log("Plot ID from URL:", plotId);

        const plotJson = Android.getSelectedPlot(parseInt(plotId)); // Use the dynamic ID
        console.log("Plot data:", plotJson);

        if (typeof visualizeData === "function") {
          visualizeData(plotJson);
        } else {
          console.error("visualizeData is not defined.");
        }
      } else {
        console.error(
          "Android interface is not available or plotId is missing."
        );
      }
    });


    document
            .getElementById("mapTypesDropdown")
            .addEventListener("click", function () {
                const dropdown = document.getElementById("dropdownContent");
                dropdown.style.display =
                    dropdown.style.display === "block" ? "none" : "block";
            });

        // Close dropdown when clicking outside
        window.addEventListener("click", function (event) {
            const dropdown = document.getElementById("dropdownContent");
            if (!event.target.matches("#mapTypesDropdown")) {
                dropdown.style.display = "none";
            }
        });



    function visualizeData(data) {
      const statusElement = document.getElementById("status");
      console.log("Data received:", data);

      try {
        // Parse the data if it is not already in JSON format
        const parsedData = typeof data === "string" ? JSON.parse(data) : data;
        console.log(
          "Parsed data:",
          parsedData.latitude,
          parsedData.longitude
        );

        // Initialize the map centered on the provided latitude and longitude
        const map = L.map("map").setView(
          [parseFloat(parsedData.latitude), parseFloat(parsedData.longitude)],
          18
        );

        // Add a tile layer to the map
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);

        // Default street view layer
        window.streetLayer = L.tileLayer(
          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          {
            maxZoom: 19,
            attribution: "¬© OpenStreetMap contributors",
          }
        ).addTo(map);

        // Satellite view layer
        window.satelliteLayer = L.tileLayer(
          "https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",
          {
            maxZoom: 19,
            attribution: "¬© Google Satellite",
          }
        );

        // Terrain view layer
        window.terrainLayer = L.tileLayer(
          "https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}",
          {
            maxZoom: 19,
            attribution: "¬© Google Maps",
          }
        );
        // Add terrain layer as the default layer
        window.terrainLayer.addTo(map);

        // // Add layer controls
        // const baseLayers = {
        //   Street: window.streetLayer,
        //   Satellite: window.satelliteLayer,
        //   Terrain: window.terrainLayer,
        // };
        // L.control.layers(baseLayers).addTo(map);

        updateTranslations(lang);


         // Map view controls
         document.getElementById("streetView").addEventListener("click", () => {
                map.removeLayer(window.satelliteLayer);
                map.removeLayer(window.terrainLayer);
                window.streetLayer.addTo(map);
            });

            document
                .getElementById("satelliteView")
                .addEventListener("click", () => {
                    map.removeLayer(window.streetLayer);
                    map.removeLayer(window.terrainLayer);
                    window.satelliteLayer.addTo(map);
                });

            document.getElementById("terrainView").addEventListener("click", () => {
                map.removeLayer(window.streetLayer);
                map.removeLayer(window.satelliteLayer);
                window.terrainLayer.addTo(map);
            });


        // Handle coordinates
        let latlngs = [];

        if (parsedData.coordinates && parsedData.coordinates.length > 0) {
          latlngs = parsedData.coordinates.map((coord) => [
            parseFloat(coord.first), // Ensure it's a number
            parseFloat(coord.second), // Ensure it's a number
          ]);
        } else if (parsedData.latitude && parsedData.longitude) {
          // Use latitude and longitude as a single point if coordinates are missing
          latlngs = [
            [
              parseFloat(parsedData.latitude),
              parseFloat(parsedData.longitude),
            ],
          ];
          console.warn(
            "Coordinates are missing or empty. Using latitude and longitude instead."
          );
        }

        // Check if latlngs contains valid numbers
        latlngs = latlngs.filter(
          (coord) => !isNaN(coord[0]) && !isNaN(coord[1])
        );

        if (latlngs.length > 0) {
          console.log("Transformed Coordinates:", latlngs);

          // Calculate the centroid (center) of the coordinates
          const centroid = latlngs
            .reduce(
              (acc, curr) => {
                acc[0] += curr[0]; // Sum latitude
                acc[1] += curr[1]; // Sum longitude
                return acc;
              },
              [0, 0]
            )
            .map((sum) => sum / latlngs.length); // Divide sums by the number of points

          console.log("Centroid Coordinates:", centroid);

          // Ensure centroid is valid before proceeding
          if (!isNaN(centroid[0]) && !isNaN(centroid[1])) {
            // Add a marker at the centroid
            const centroidMarker = L.marker(centroid).addTo(map);
            centroidMarker.bindPopup(`
    <b>${t("centroidInfo")}</b><br>
    Latitude: ${centroid[0].toFixed(6)}<br>
    Longitude: ${centroid[1].toFixed(6)}
  `);
          } else {
            console.warn("Invalid centroid calculated.");
          }

          // Draw the polygon (or point if only one lat/lng)
          if (latlngs.length > 1) {
            const polygon = L.polygon(latlngs, { color: "blue" }).addTo(map);
            polygon.bindPopup(`
     <b>${t("farmInfo")}</b><br>
    ${t("siteId")}: ${parsedData.siteId}<br>
    ${t("farmer")}: ${parsedData.farmerName}<br>
    ${t("village")}: ${parsedData.village}<br>
    ${t("district")}: ${parsedData.district}<br>
    ${t("size")}: ${parsedData.size} ${t("hectares")}
  `);
          } else {
            const marker = L.marker(latlngs[0]).addTo(map);
            marker.bindPopup(`
     <b>${t("farmInfo")}</b><br>
    ${t("siteId")}: ${parsedData.siteId}<br>
    ${t("farmer")}: ${parsedData.farmerName}<br>
    ${t("village")}: ${parsedData.village}<br>
    ${t("district")}: ${parsedData.district}<br>
    ${t("size")}: ${parsedData.size} ${t("hectares")}
  `);
          }
        } else {
          console.warn("No valid coordinates available.");
        }

        // Log the farm details for debugging
        console.log("Farm Details:");
        console.log(`Site ID: ${parsedData.siteId}`);
        console.log(`Farmer Name: ${parsedData.farmerName}`);
        console.log(
          `Coordinates: ${
            parsedData.coordinates && parsedData.coordinates.length > 0
              ? JSON.stringify(parsedData.coordinates)
              : "None"
          }`
        );

        // Update the status to indicate the map was loaded successfully
        // ‚úÖ Translate Status Message
        statusElement.textContent = t("mapLoaded");
        statusElement.classList.remove("error");
      } catch (error) {
        // Handle and display errors
        statusElement.textContent = `${t("errorLoadingMap")} ${
          error.message
        }`;
        statusElement.classList.add("error");
        console.error("Error visualizing data:", error);
      }
    }
</script>
</body>
</html>
